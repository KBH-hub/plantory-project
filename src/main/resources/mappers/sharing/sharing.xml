<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zero.plantory.domain.sharing.mapper.SharingMapper">

<select id="selectSharingListByAddressAndKeyword"
        parameterType="com.zero.plantory.domain.sharing.vo.SharingSearchVO"
        resultType="com.zero.plantory.domain.sharing.vo.SharingCardListVO">

    SELECT
        s.sharing_id,
        s.title,
        s.interest_num,
        s.status,
        s.created_at,

        (
            SELECT COUNT(*)
            FROM comment c
            WHERE c.sharing_id = s.sharing_id
              AND c.del_flag IS NULL
        ) AS comment_count,

        (
            SELECT i.file_url
            FROM image i
            WHERE i.target_type = 'SHARING'
              AND i.target_id = s.sharing_id
              AND i.del_flag IS NULL
            ORDER BY i.image_id ASC, i.created_at ASC
             LIMIT 1
        ) AS image_url

    FROM sharing s
        JOIN member m ON s.member_id = m.member_id

    WHERE m.address LIKE CONCAT(#{userAddress}, '%')
      AND s.del_flag IS NULL
      AND m.del_flag IS NULL
      AND (#{keyword} IS NULL OR #{keyword} = '' OR s.title LIKE CONCAT('%', #{keyword}, '%'))

    ORDER BY s.created_at DESC

    LIMIT #{limit} OFFSET #{offset}

    </select>


    <select id="countInterestByMemberId" resultType="int">
        SELECT COUNT(*)
        FROM interest i
                 JOIN sharing s ON i.sharing_id = s.sharing_id
        WHERE i.member_id = #{memberId}
          AND s.del_flag IS NULL
    </select>

    <select id="selectPopularSharingList" resultType="com.zero.plantory.domain.sharing.vo.SharingPopularVO">

        SELECT
            sharing_id,
            title,
            interest_num
        FROM sharing
        WHERE del_flag IS NULL
          AND interest_num IS NOT NULL
          AND created_at >= DATE_SUB(NOW(), INTERVAL 1 MONTH)
        ORDER BY interest_num DESC, created_at DESC
            LIMIT 3

    </select>

    <insert id="insertSharing"
            parameterType="com.zero.plantory.global.vo.SharingVO"
            useGeneratedKeys="true"
            keyProperty="sharingId">

        INSERT INTO sharing
        (member_id, target_member_id, title, content, plant_type,
         management_level, management_needs,
         interest_num, status, created_at)
        VALUES
            (#{memberId},
             #{targetMemberId},
             #{title},
             #{content},
             #{plantType},
             #{managementLevel},
             #{managementNeeds},
             0,
             'false',
             NOW())
    </insert>

    <select id="selectSharingDetail" resultType="com.zero.plantory.domain.sharing.vo.SelectSharingDetailVO">
        SELECT
            s.sharing_id,
            s.member_id,
            mb.nickname,
            mb.sharing_rate,
            s.title,
            s.content,
            s.plant_type,
            s.management_level,
            s.management_needs,
            s.interest_num,
            s.status,
            s.created_at,
            s.updated_at
        FROM sharing s
                 JOIN member mb ON s.member_id = mb.member_id
        WHERE s.sharing_id = #{sharingId}
          AND s.del_flag IS NULL
          AND mb.del_flag IS NULL
    </select>

    <select id="selectSharingComments"
            parameterType="long"
            resultType="com.zero.plantory.domain.sharing.vo.SelectSharingCommentVO">

        SELECT
            c.comment_id,
            c.writer_id,
            mb.nickname,
            c.content,
            c.created_at,
            c.updated_at
        FROM comment c
                 JOIN member mb ON c.writer_id = mb.member_id
        WHERE c.sharing_id = #{sharingId}
          AND c.del_flag IS NULL
          AND mb.del_flag IS NULL
        ORDER BY c.created_at ASC

    </select>

    <select id="countInterest" resultType="int">
        SELECT COUNT(*)
        FROM interest
        WHERE member_id = #{memberId}
          AND sharing_id = #{sharingId}
    </select>


    <insert id="insertInterest">
        INSERT INTO interest (member_id, sharing_id)
        VALUES (#{memberId}, #{sharingId})
    </insert>


    <delete id="deleteInterest">
        DELETE FROM interest
        WHERE member_id = #{memberId}
          AND sharing_id = #{sharingId}
    </delete>


    <update id="increaseInterestNum">
        UPDATE sharing
        SET interest_num = interest_num + 1
        WHERE sharing_id = #{sharingId}
    </update>


    <update id="decreaseInterestNum">
        UPDATE sharing
        SET interest_num = GREATEST(interest_num - 1, 0)
        WHERE sharing_id = #{sharingId}
    </update>

    <insert id="insertComment">
        INSERT INTO comment
            (sharing_id, writer_id, content, created_at, updated_at, del_flag)
        VALUES
            (#{sharingId}, #{writerId}, #{content}, NOW(), NULL, NULL)
    </insert>

    <select id="countMyComment" resultType="int">
        SELECT COUNT(*)
        FROM comment
        WHERE comment_id = #{commentId}
          AND sharing_id = #{sharingId}
          AND writer_id  = #{writerId}
          AND del_flag IS NULL
    </select>

    <update id="updateCommentById">
        UPDATE comment
        SET content    = #{content},
            updated_at = NOW()
        WHERE comment_id = #{commentId}
          AND sharing_id = #{sharingId}
          AND writer_id  = #{writerId}
          AND del_flag IS NULL
    </update>

    <update id="deleteComment" parameterType="com.zero.plantory.global.vo.CommentVO">
        UPDATE comment
        SET del_flag = NOW()
        WHERE comment_id = #{commentId}
          AND sharing_id = #{sharingId}
          AND writer_id  = #{writerId}
          AND del_flag IS NULL
    </update>

    <select id="countMySharing" resultType="int">
        SELECT COUNT(*)
        FROM sharing
        WHERE sharing_id = #{sharingId}
          AND member_id = #{memberId}
          AND del_flag IS NULL
    </select>

    <update id="updateSharing"
            parameterType="com.zero.plantory.global.vo.SharingVO">
        UPDATE sharing
        SET title            = #{title},
            content          = #{content},
            plant_type       = #{plantType},
            management_level = #{managementLevel},
            management_needs = #{managementNeeds},
            updated_at       = NOW()
        WHERE sharing_id = #{sharingId}
          AND member_id  = #{memberId}
          AND del_flag IS NULL
    </update>

    <update id="deleteSharingImage"
            parameterType="com.zero.plantory.global.vo.ImageVO">
        UPDATE image
        SET del_flag = NOW()
        WHERE target_type = #{targetType}
          AND target_id = #{targetId}
          AND image_id  = #{imageId}
    </update>

    <insert id="insertSharingImage"
            parameterType="com.zero.plantory.global.vo.ImageVO">
        INSERT INTO image
        (member_id, target_type, target_id, file_url, file_name, created_at, del_flag)
        VALUES
            (#{memberId}, #{targetType}, #{targetId}, #{fileUrl}, #{fileName}, NOW(), NULL)
    </insert>





</mapper>